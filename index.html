<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #solution-container {border: 1px solid #ccc; min-height: 100px;}
    </style>
</head>
<body>
    <div>Navigation</div>
    <div id="lesson-container"></div>
    <p id="question">Question</p>
    <div id="solution-container"></div>
    <div id="button-container"></div>
    <button id="run-button" disabled>Run</button>
    <div id="feedback-panel"></div>
    <pre id="output-container"></pre>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>

        //Supabase
        const supabaseUrl = 'https://duxyhokarzqpzgqpvzwv.supabase.co'
        const supabasePublishableKey = 'sb_publishable_gZnAJV4cZ481p1cz23JPAw_TqOiOOiX';

        const supabase = window.supabase.createClient(supabaseUrl, supabasePublishableKey);
        
        const questionElement = document.getElementById('question');
        const buttonContainer = document.getElementById('button-container');
        const solutionContainer = document.getElementById('solution-container');
        const outputContainer = document.getElementById('output-container');
        const runButton = document.getElementById('run-button');
        const lessonContainer = document.getElementById('lesson-container');

        let lessonIndex = 0;
        let questionIndex = 0;
        let currentQuestions = [];
        const questionsByLesson = new Map();

        supabase.auth.getSession().then(({ data, error }) => {
            if(error) {
                console.error('Supabase init error:', error);
            } else {
                console.log('Supabase ready. User:', data.session?.user?.id ?? null);
            }
        })
        
        
        async function fetchLessons() {
            const { data, error } = await supabase
            .from('lessons')
            .select('id, title, sort_order, created_at')
            .order('sort_order', { ascending: true });
            
            if(error) {
                console.error('lessons select error:', error);
                return[];
            }
            console.log('lessons:', data);
            return data;
            
        }
        
        async function loadLessons() {
            lessonContainer.innerHTML = '';
            const rows = await fetchLessons();
            rows.forEach((row) => {
                const lessonButton = document.createElement('button');
                lessonButton.textContent = row.title;
                lessonButton.addEventListener('click', () => {
                    loadQuestions(row.id);
                });
                lessonContainer.appendChild(lessonButton);
            });
        }

        async function fetchQuestions(lessonId) {
            const { data, error } = await supabase
            .from('questions')
            .select('id, lesson_id, prompt, tokens, solution, sort_order, created_at')
            .eq('lesson_id', lessonId)
            .order('sort_order', { ascending: true });

            if(error) {
                console.error('question select error:', error);
                return [];
            } else {
                console.log('questions:', data);
                return data;
            }
        }

        async function loadQuestions(lessonId) {
           questionIndex = 0;
           runButton.disabled = true;
           const cached = questionsByLesson.get(lessonId);
           if(cached) { currentQuestions = cached; return; }
           const questionSet = await fetchQuestions(lessonId);
           questionsByLesson.set(lessonId, questionSet);
           currentQuestions = questionSet;
        }

        loadLessons();

        
        
        const pyodidePromise = loadPyodide();

        runButton.addEventListener('click', async () => {
            if (runButton.textContent === 'Continue') {
                if (questionIndex === lessons[lessonIndex].questions.length - 1) {
                    console.log('You have completed the quiz');
                    return;
                }
                questionIndex++;
                updateQuestion();
                runButton.textContent = 'Run';
                return;
            } else {
                const pyodide = await pyodidePromise;
                outputContainer.textContent = 'Running...';
                const code = Array.from(solutionContainer.querySelectorAll('button')).map(b => b.textContent).join('');
                try {
                    pyodide.globals.set('code', code);
                    const result = await pyodide.runPythonAsync(`import sys, io\nbuf = io.StringIO()\n_stdout, _stderr = sys.stdout, sys.stderr\nsys.stdout = sys.stderr = buf\ntry:\n    exec(code, {})\nfinally:\n    sys.stdout, sys.stderr = _stdout, _stderr\nbuf.getvalue()`);
                    outputContainer.textContent = result || '(no output)';
                } catch (e) {
                    outputContainer.textContent = String(e);
                }
    
                const feedbackPanel = document.getElementById('feedback-panel');
                if (code === lessons[lessonIndex].questions[questionIndex].solution) {
                    feedbackPanel.textContent = 'Correct!';
                } else {
                    feedbackPanel.textContent = 'Incorrect!';
                }
                runButton.textContent = 'Continue';
            }
        });


        function updateQuestion() {
            questionElement.textContent = lessons[lessonIndex].questions[questionIndex].question;
            buttonContainer.innerHTML = '';
            solutionContainer.innerHTML = '';
            lessons[lessonIndex].questions[questionIndex].tokens.forEach((token) => {
                const button = document.createElement('button');
                button.textContent = token;
                button.addEventListener('click', () => (button.parentElement === solutionContainer ? buttonContainer : solutionContainer).appendChild(button));
                buttonContainer.appendChild(button);
                button.addEventListener('click', () => { runButton.disabled = solutionContainer.children.length === 0; });
            });
        }


    </script>
</body>
</html>